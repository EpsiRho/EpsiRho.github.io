<!DOCTYPE html>
<html lang="en">
    <head>
        <script type="module" src="https://unpkg.com/@fluentui/web-components"></script>
        <link rel="stylesheet" href="tomorrow-night.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
        <link rel="stylesheet" href="projectstyles.css">
        <script type="module" src="projectscript.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div id="background_wrap"></div>
        <div class="CardContainer">
            
            <fluent-card class="AdditionalCard">
                <h1 id="momentum-and-file-performance-quirks-in-windows-application-frameworks">Momentum and File Performance in UWP</h1>
<p>Recently, inspired by the lack of an open source codebase for <a href="https://www.voidtools.com/">Everything</a> and some discussion with some devs on discord, I started a project I call Momentum. It was originally planned for UWP, to be a file indexer and search that had a modern Windows 11 look and feel. However, I found some weird issues while working on the indexer code.</p>
<h2 id="console-code">Console code</h2>
<p>I started development on the indexer and search functions, which I programmed in a C# Console Application. The first goal was simple, create a performant indexer using hash tables and json. A simple <code>Dictionary&lt;string, string&gt;</code> was used first, but later became a <code>Dictionary&lt;string, IndexedFileInfo&gt;</code>. </p>
<h4 id="indexer-code">Indexer code</h4>
<ul>
<li>Recursively scan through every folder from x starting point. </li>
<li>Handle exceptions thrown by folders who block access. </li>
<li>return one filled dictionary with all files and folders scanned. </li>
</ul>
<pre><code class="cs">public static void IndexFiles()
{
    <span class="hljs-keyword">var</span> dictionary = SearchDirectory(<span class="hljs-string">"C:\\Users\\jhset\\Pictures"</span>);
    <span class="hljs-keyword">Display</span>.Message = <span class="hljs-string">"Saving to File"</span>;
    SaveIndexesToFile(dictionary);
}

private static Dictionary&lt;string, <span class="hljs-keyword">List</span>&lt;IndexedFileInfo&gt;&gt; SearchDirectory(string path)
{
    <span class="hljs-keyword">var</span> dictionary = new Dictionary&lt;string, <span class="hljs-keyword">List</span>&lt;IndexedFileInfo&gt;&gt;();
    try
    {
        <span class="hljs-comment">// Get directories in path</span>
        <span class="hljs-keyword">var</span> dirs = Directory.GetDirectories(path);

        <span class="hljs-comment">// If ther are dirs, recursively check them</span>
        <span class="hljs-keyword">if</span> (dirs.Length &gt; 0)
        {
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> <span class="hljs-keyword">dir</span> <span class="hljs-keyword">in</span> dirs)
            {
                <span class="hljs-keyword">var</span> <span class="hljs-keyword">ret</span> = SearchDirectory(<span class="hljs-keyword">dir</span>);

                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> f <span class="hljs-keyword">in</span> <span class="hljs-keyword">ret</span>)
                {
                    <span class="hljs-keyword">if</span> (dictionary.ContainsKey(f.Key))
                    {
                        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> s <span class="hljs-keyword">in</span> f.Value)
                        {
                            dictionary[f.Key].Add(s);
                        }
                    }
                    <span class="hljs-keyword">else</span>
                    {
                        dictionary.Add(f.Key, new <span class="hljs-keyword">List</span>&lt;IndexedFileInfo&gt;(f.Value));
                    }
                }
            }
        }

        <span class="hljs-comment">// Get the files in this dir</span>
        <span class="hljs-keyword">var</span> files = Directory.GetFiles(path);

        <span class="hljs-comment">// Add each file to dictionary</span>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> <span class="hljs-keyword">file</span> <span class="hljs-keyword">in</span> files)
        {
            string name = <span class="hljs-keyword">file</span>.<span class="hljs-keyword">Split</span>(<span class="hljs-string">"\\"</span>).Last().ToLower();
            <span class="hljs-keyword">var</span> <span class="hljs-keyword">list</span> = new <span class="hljs-keyword">List</span>&lt;IndexedFileInfo&gt;();
            <span class="hljs-keyword">list</span>.Add(new IndexedFileInfo() { Icon = <span class="hljs-string">"&amp;#xE130;"</span>, Path = <span class="hljs-keyword">file</span>});
            <span class="hljs-keyword">if</span> (dictionary.ContainsKey(name))
            {
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> s <span class="hljs-keyword">in</span> <span class="hljs-keyword">list</span>)
                {
                    dictionary[name].Add(s);
                }
            }
            <span class="hljs-keyword">else</span>
            {
                dictionary.Add(name, <span class="hljs-keyword">list</span>);
            }    
        }

        <span class="hljs-comment">// Finally, add this folder to the dictionary</span>
        string foldername = path.<span class="hljs-keyword">Split</span>('\\').Last().ToLower();
        <span class="hljs-keyword">var</span> <span class="hljs-keyword">flist</span> = new <span class="hljs-keyword">List</span>&lt;IndexedFileInfo&gt;();
        <span class="hljs-keyword">flist</span>.Add(new IndexedFileInfo() { Icon = <span class="hljs-string">"&amp;#xE8B7;"</span>, Path = path });
        <span class="hljs-keyword">Display</span>.IndexedFolders++;
        <span class="hljs-keyword">if</span> (dictionary.ContainsKey(foldername))
        {
            dictionary[foldername].Add(new IndexedFileInfo() { Icon = <span class="hljs-string">"&amp;#xE8B7;"</span>, Path = path });
        }
        <span class="hljs-keyword">else</span>
        {
            dictionary.Add(foldername, <span class="hljs-keyword">flist</span>);
        }

    }

    catch (Exception <span class="hljs-keyword">ex</span>)
    {
        <span class="hljs-keyword">Display</span>.TotalErrored++;
        <span class="hljs-keyword">return</span> new Dictionary&lt;string, <span class="hljs-keyword">List</span>&lt;IndexedFileInfo&gt;&gt;();
    }
    <span class="hljs-keyword">return</span> dictionary;

}
</code></pre>
<h4 id="saving-code">Saving code</h4>
<ul>
<li>Serialize the dictionary to json</li>
<li>Save to a file. </li>
</ul>
<pre><code class="lang-CSharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> SaveIndexesToFile(Dictionary&lt;<span class="hljs-keyword">string</span>, List&lt;IndexedFileInfo&gt;&gt; dictionary)
{

    <span class="hljs-keyword">string</span> <span class="hljs-built_in">text</span> = JsonConvert.SerializeObject(dictionary, Formatting.Indented);
    <span class="hljs-built_in">File</span>.WriteAllText(<span class="hljs-string">"C:\\Users\\jhset\\Desktop\\Index.json"</span>, <span class="hljs-built_in">text</span>);
}
</code></pre>
<h4 id="loading-code">Loading code</h4>
<ul>
<li>Load file in as string</li>
<li>Deserialize json to dictionary</li>
</ul>
<pre><code class="lang-CSharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Dictionary&lt;<span class="hljs-keyword">string</span>, List&lt;IndexedFileInfo&gt;&gt; LoadIndexesFromFile()

{
    <span class="hljs-built_in">try</span>
    {
        <span class="hljs-keyword">string</span> <span class="hljs-built_in">text</span> = <span class="hljs-built_in">File</span>.ReadAllText(<span class="hljs-string">"C:\\Users\\jhset\\Desktop\\Index.json"</span>);
        var obj = JsonConvert.DeserializeObject&lt;Dictionary&lt;<span class="hljs-keyword">string</span>, List&lt;IndexedFileInfo&gt;&gt;&gt;(<span class="hljs-built_in">text</span>);
        <span class="hljs-built_in">return</span> obj;
    }
    <span class="hljs-built_in">catch</span> (Exception)
    {
    <span class="hljs-built_in">return</span> null;
    }
}
</code></pre>
<h4 id="searching-code">Searching code</h4>
<ul>
<li>Search dictionary for results containing x</li>
<li>Display. </li>
</ul>
<pre><code class="lang-CSharp"><span class="hljs-keyword">var</span> <span class="hljs-keyword">list</span> = files.Where(o =&gt; o.Key.Contains(input)).ToList();
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++)
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> line in <span class="hljs-keyword">list</span>[i].Value)
        {
            Console.WriteLine($<span class="hljs-string">"{list[i].Key}"</span>);
        }
    }
    <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">Exception</span>)
    {

    }
}
</code></pre>
<h4 id="results">Results</h4>
<p>The results of this first test were good, really good. Better than I was expecting. 
The test set was my C Drive, a Samsung SSD 970 EVO 1TB. Each test indexed 10,575,799 files. The inital console test was great, and brought in an indexing time of 70 seconds and saving time of 5 seconds.</p>
<h2 id="moving-to-a-proper-ui">Moving to a proper UI</h2>
<p>I wanted to move this project to a UI framework, initally I wanted it to be UWP because mica isn&#39;t available in the WinUI 3 yet. So I get to work developing a simple UI and porting over the code. With the BroadFilesystemAccess capability enabled, the code for the file indexer could be exactly the same. I started running the first test and.. why is it so slow?</p>
<p>I looked back and forth. &quot;No, the code is the same!&quot; I tried disabling the UI that shows the current ammount of files indexed and elpased time since start. No, still not done after waiting 10 minutes. It&#39;s not just slow, it&#39;s <strong>SLOW</strong>. So now I need to check something</p>
<h2 id="wpf-and-the-wasdk">WPF and the WASDK</h2>
<p>So I created two other projects with simple UIs, and ported the code over. </p>
<p><img src="https://i.imgur.com/6eXkFNe.png" alt=""><br/>
<em>Times showed in seconds</em></p>
<p>Not bad, WASDK came out a bit slower but otherwise not bad. So you&#39;re probably thinking &quot;Well where&#39;s UWP&#39;s times?&quot;</p>
<p><img src="https://i.imgur.com/pSG6E8r.png" alt=""></p>
<p>Ah.
Thats 3 hours, 31 minutes, and 41 seconds. So, what the fuck?</p>
<p>Sadly, I don&#39;t have a good answer for this. My assumption is that the sandbox model causes file access to take more time. It sucks that even with the BroadFileSystem capability UWP&#39;s file access is so slow. </p>
<p>So I decided to move to the WASDK. Goodbye Mica, my beloved. This transition wasn&#39;t without issues either. When saving and loading I encountered a <code>System.OutOfMemoryException</code>. This only happened here, I don&#39;t have a good answer for why, but I had to design around it.</p>
<h4 id="new-saving-code">New saving code</h4>
<pre><code class="lang-CSharp">private static void SaveIndexesToFile(Dictionary&lt;<span class="hljs-keyword">string</span>, List&lt;IndexedFileInfo&gt;&gt; dictionary)
{
    <span class="hljs-keyword">string</span> path = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
    <span class="hljs-keyword">string</span>[] dirs = Directory.GetDirectories(path);
    <span class="hljs-keyword">if</span> (!dirs.Contains(<span class="hljs-string">"Momentum"</span>))
    {
        <span class="hljs-keyword">System</span>.IO.Directory.CreateDirectory($<span class="hljs-string">"{path}\\Momentum"</span>);
    }

    StreamWriter sw = File.CreateText($<span class="hljs-string">"{path}\\Momentum\\Index.json"</span>);
    JsonTextWriter <span class="hljs-built_in">writer</span> = <span class="hljs-keyword">new</span> JsonTextWriter(sw);
    <span class="hljs-built_in">writer</span>.Formatting = Formatting.Indented;
    <span class="hljs-built_in">writer</span>.WriteStartObject();
    Files = <span class="hljs-keyword">new</span> ConcurrentDictionary&lt;<span class="hljs-keyword">string</span>, List&lt;IndexedFileInfo&gt;&gt;();
    foreach (var item in dictionary)
    {
        Files.TryAdd(item.<span class="hljs-built_in">Key</span>, item.Value);
        <span class="hljs-built_in">writer</span>.WritePropertyName(item.<span class="hljs-built_in">Key</span>);
        <span class="hljs-built_in">writer</span>.WriteStartArray();
        foreach (var file in item.Value)
        {
            <span class="hljs-built_in">writer</span>.WriteStartObject();
            <span class="hljs-built_in">writer</span>.WritePropertyName(<span class="hljs-string">"Name"</span>);
            <span class="hljs-built_in">writer</span>.WriteValue(item.<span class="hljs-built_in">Key</span>);
            <span class="hljs-built_in">writer</span>.WritePropertyName(<span class="hljs-string">"Path"</span>);
            <span class="hljs-built_in">writer</span>.WriteValue(file.Path);
            <span class="hljs-built_in">writer</span>.WritePropertyName(<span class="hljs-string">"Icon"</span>);
            <span class="hljs-built_in">writer</span>.WriteValue(file.Icon);
            <span class="hljs-built_in">writer</span>.WriteEndObject();
        }
        <span class="hljs-built_in">writer</span>.WriteEndArray();
        sw.Flush();
    }
    <span class="hljs-built_in">writer</span>.WriteEndObject();

    <span class="hljs-built_in">writer</span>.Flush();
    <span class="hljs-built_in">writer</span>.<span class="hljs-built_in">Close</span>();
}
</code></pre>
<h4 id="new-loading-code">New loading code</h4>
<pre><code class="lang-CSharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoadIndexesFromFile</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-keyword">try</span>
    {
        IsFullyLoaded = <span class="hljs-literal">false</span>;
        Files = <span class="hljs-keyword">new</span> ConcurrentDictionary&lt;<span class="hljs-keyword">string</span>, List&lt;IndexedFileInfo&gt;&gt;();

        <span class="hljs-keyword">string</span> p = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
        <span class="hljs-keyword">string</span>[] dirs = Directory.GetDirectories(p);
        <span class="hljs-keyword">if</span> (!dirs.Contains(<span class="hljs-string">"Momentum"</span>))
        {
            System.IO.Directory.CreateDirectory(<span class="hljs-string">$"<span class="hljs-subst">{p}</span>\\Momentum"</span>);
        }

        StreamReader sr = File.OpenText(<span class="hljs-string">$"<span class="hljs-subst">{p}</span>\\Momentum\\Index.json"</span>);
        JsonTextReader reader = <span class="hljs-keyword">new</span> JsonTextReader(sr);

        <span class="hljs-keyword">while</span> (reader.Read())
        {
            <span class="hljs-keyword">if</span> (reader.Value != <span class="hljs-literal">null</span>)
            {
                <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">new</span> KeyValuePair&lt;<span class="hljs-keyword">string</span>, List&lt;IndexedFileInfo&gt;&gt;();
                reader.Read();
                reader.Read();
                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
                {
                    reader.Read();
                    reader.Read();
                    <span class="hljs-keyword">string</span> name = reader.Value.ToString();
                    reader.Read();
                    reader.Read();
                    <span class="hljs-keyword">string</span> path = reader.Value.ToString();
                    reader.Read();
                    reader.Read();
                    <span class="hljs-keyword">string</span> icon = reader.Value.ToString();
                    reader.Read();
                    reader.Read();
                    <span class="hljs-keyword">if</span> (Files.ContainsKey(name))
                    {
                        Files[name].Add(<span class="hljs-keyword">new</span> IndexedFileInfo() { Name = name, Path = path, Icon=icon });
                    }
                    <span class="hljs-keyword">else</span>
                    {
                        <span class="hljs-keyword">var</span> lst = <span class="hljs-keyword">new</span> List&lt;IndexedFileInfo&gt;();
                        lst.Add(<span class="hljs-keyword">new</span> IndexedFileInfo() { Name = name, Path = path, Icon = icon });
                        Files.TryAdd(name, lst);
                    }
                    <span class="hljs-keyword">if</span> (reader.TokenType == JsonToken.EndArray)
                    {
                        <span class="hljs-keyword">break</span>;
                    }
                }
            }
        }
        IsFullyLoaded = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">//var obj = JsonReader .DeserializeObject&lt;Dictionary&lt;string, List&lt;IndexedFileInfo&gt;&gt;&gt;(text);</span>
        <span class="hljs-comment">//Files = obj;</span>

    }
    <span class="hljs-keyword">catch</span> (Exception)
    {
        <span class="hljs-keyword">return</span>;
    }
}
</code></pre>
<p>The new loading code is cool because the application can now load in files while you search, so the user can search before the full index file is done loading. This is nice because larger index files can take a few seconds to load.</p>
<h2 id="wasdk-and-the-final-application">WASDK and the final application</h2>
<p>As much as I&#39;ll miss mica, the WASDK is nice to use. If you&#39;re coming from UWP, you&#39;ll be right at home. Only a few things differ, but the XAML code is mostly the same. 
    <p><img src="https://i.imgur.com/Wis90Kz.png" alt=""></p>
    <p><img src="https://i.imgur.com/K0woRdC.png" alt=""></p>
<p>If you want to test the application out and see the full source code, check out the <a href="https://github.com/EpsiRho/Momentum">GitHub Repository!</a></p>

            </fluent-card>
            
        </div>
    </body>
</html>